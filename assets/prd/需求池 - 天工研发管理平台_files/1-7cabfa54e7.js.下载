(window.microFrontendlayout=window.microFrontendlayout||[]).push([[1],{Exws:function(e,t,r){"use strict";r.r(t);var s=r("u52W"),a=r("cDcd"),c=r.n(a),n=r("h74D"),o=r("rKB8"),i=r("Puqe"),l=r.n(i),u=r("rR9+"),d=r("grnQ"),m=r("5JFE"),h=r("ehTL"),f=r("CO6D");const{GET_PROJECT_PREFERENCES:O,TOGGLE_PROJECT_PREFERENCE:g}=f.ACTION;function p(e,t,r){return(s,a)=>{const{platformProjectIdPreferenceApiPrefix:c}=a().APP;Object(h.post)(`${c}/${e}/preference/toggle`,{type:t,status:r}).then(a=>(s({type:g,projectId:e,preferenceType:t,status:r}),a))}}var j=r("GsLh"),E=r("wMS7"),b=r.n(E),P=r("WkxT"),y=r.n(P),S=r("fku+"),v=r.n(S),C=r("SQcZ"),w=r.n(C),T=r("sEfC"),_=r.n(T),R=r("0FX9"),A=r.n(R),N=r("R+3M"),I=function(e,t,r,s){return new(r||(r=Promise))((function(a,c){function n(e){try{i(s.next(e))}catch(t){c(t)}}function o(e){try{i(s.throw(e))}catch(t){c(t)}}function i(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(n,o)}i((s=s.apply(e,t||[])).next())}))};const D={verticalAlign:"text-bottom"};var k=e=>{const{qrcodeImage:t,oauthConfig:r,setQrcodeImage:n,setOauthConfig:o,setRefreshQrcode:i,setFlag:l}=(e=>{const[t,r]=Object(a.useState)({}),[s,c]=Object(a.useState)(""),[n,o]=Object(a.useState)({}),[i,l]=Object(a.useState)(0),[u,d]=Object(a.useState)(!1);let m;return Object(a.useLayoutEffect)(()=>{e&&I(void 0,void 0,void 0,(function*(){try{const e=yield Object(N.c)(),t=Object.assign(Object.assign({},e),{responseText:JSON.parse(e.responseText)});A.a.toString(t.responseText.short_url,{type:"terminal"},(e,t)=>{c(t)}),r(t)}catch(e){r({})}}))},[i,e]),Object(a.useLayoutEffect)(()=>(t.uuid&&(m=window.setTimeout(()=>{d(!0)},6e5)),()=>window.clearTimeout(m)),[t.uuid]),Object(a.useLayoutEffect)(()=>{let r=!1;const s={success:!1,message:"check status error."};if(e&&t.uuid){const e=encodeURIComponent(t.responseText.login_status_url),a=_()(()=>I(void 0,void 0,void 0,(function*(){if(!r)try{const r=yield Object(N.a)(e),s=Object.assign(Object.assign({},r),{uuid:t.uuid});!0===s.success&&(window.clearTimeout(m),o(s),a.cancel())}catch(c){u?o(s):a()}})),1e3);a()}return()=>{r=!0}},[t,t.uuid,u,e]),{qrcodeImage:s,oauthConfig:n,refreshQrcode:i,setQrcodeImage:c,setOauthConfig:o,setRefreshQrcode:l,setFlag:d}})(!0);Object(a.useLayoutEffect)(()=>{r.success&&e.onSuccess(r)},[r]);const u=Object(a.useCallback)(()=>{n(""),o({}),l(!1),i(e=>e+1)},[]),d=c.a.createElement(a.Fragment,null,c.a.createElement("div",{className:w.a.formAuthSecret},c.a.createElement("div",{className:w.a.formOauthTitle},r.secret_key?c.a.createElement("span",{className:w.a.formOauthSuccess},c.a.createElement(v.a,{style:D}),Object(s.t)("\u5df2\u6388\u6743\u6210\u529f")):c.a.createElement(a.Fragment,null,c.a.createElement("span",null,Object(s.t)("\u5fae\u4fe1\u626b\u7801\u83b7\u53d6\u4e34\u65f6\u6743\u9650")),c.a.createElement("span",{className:w.a.formOauthRefresh,onClick:u},c.a.createElement("span",null,Object(s.t)("\u5237\u65b0\u4e8c\u7ef4\u7801"),"\xa0"),c.a.createElement(y.a,{style:D})))),c.a.createElement("div",{className:w.a.formOauthQrcode,dangerouslySetInnerHTML:{__html:b.a.sanitize(t)}})),!1===r.success&&c.a.createElement("div",{className:w.a.formDescWarning},Object(s.t)("\u4e34\u65f6\u6743\u9650\u6388\u6743\u672a\u6210\u529f, \u5237\u65b0\u4e8c\u7ef4\u7801\u53ef\u91cd\u65b0\u6388\u6743")));return c.a.createElement("div",{className:w.a.qrcodeWrapper},d)};const x=[{action:d.a.VIEW,function:d.b.PROJECT_CI}],M=localStorage.getItem("serverless_demo_auth_modal_interval"),K=localStorage.getItem("serverless_demo_start_time"),F=+new Date(K||"2020/03/31 23:59:59"),q=M?+M:864e5;class L extends c.a.Component{constructor(){super(...arguments),this.state={isInitial:!1,canUrlChange:!0,warningInfo:"",modalVisible:!0,qrcodeKey:Date.now()},this.hasPreferences=()=>{const{currentProject:e,projectPreferences:t}=this.props;return t.find(t=>t.projectId===e.id&&9===t.type&&1===t.status)},this.handleContinue=()=>{const e=Date.now();localStorage.setItem(j.k,JSON.stringify(e)),this.setState({modalVisible:!1})},this.handleRecordAuth=()=>{const{currentProject:e,toggleProjectPreference:t}=this.props;return t(e.id,9,1)},this.handleOathSuccess=(e={})=>{const t=l()(e,"success"),{enterpriseGlobalKey:r,currentProject:a}=this.props,c={rawSlsCredential:t,type:"TENCENT_SERVERLESS",allSelect:!1,name:a.name||"demoProject",taskDTOS:[]};this.handleRecordAuth().then(()=>{return e=r,t=c,Object(h.putJSON)(`/api/t/${e}/demo/credential`,t);var e,t}).then(()=>{this.setState({modalVisible:!1})}).catch(()=>{m.message.warning(Object(s.t)("\u6388\u6743\u5931\u8d25\uff0c\u8bf7\u91cd\u65b0\u626b\u7801\uff01")),this.setState({qrcodeKey:Date.now()})})},this.canRenderModal=()=>{const{isAdmin:e,currentProject:t}=this.props,r=localStorage.getItem(j.k),s=Date.now(),a=!r||s-+r>q,c=t.created_at>F;return e&&t.isDemo&&!this.hasPreferences()&&a&&c}}render(){const{qrcodeKey:e}=this.state;return this.canRenderModal()?c.a.createElement(m.Modal,{maskClosable:!1,visible:this.state.modalVisible,className:w.a.serverlessAuthModal,onCancel:this.handleContinue,title:Object(s.t)("\u5fae\u4fe1\u626b\u7801\uff0c\u5373\u53ef\u4f53\u9a8c\u5b8c\u6574\u7684 DevOps \u6d41\u7a0b")},c.a.createElement("div",null,c.a.createElement(k,{key:e,onSuccess:this.handleOathSuccess})),c.a.createElement("div",{className:w.a.footer},c.a.createElement(m.Button,{onClick:this.handleContinue},Object(s.t)("\u8df3\u8fc7")))):null}}L.defaultProps={projectPreferences:[],currentProject:{}};const Q=Object(n.connect)((function(e){return{enterpriseGlobalKey:e.APP.enterprise.globalKey,currentProject:e.APP.currentProject,isAdmin:e.APP.isAdmin,projectPreferences:e.APP.projectPreferences}}),e=>Object.assign({},Object(o.bindActionCreators)({toggleProjectPreference:p},e)))(L);t.default=Object(u.d)({key:u.a.CI_CD_MANAGEMENT})(Object(d.c)({by:x,getRedirectURL:()=>"/unauthorized"})(Q))},SQcZ:function(e,t,r){e.exports={"serverless-auth-modal":"serverless-auth-modal-2yoNPR9CHZ",serverlessAuthModal:"serverless-auth-modal-2yoNPR9CHZ",header:"header-2E5La_qQH2",footer:"footer-3JG20SGC6v","form-oauth-title":"form-oauth-title-Mvl0DPCXTi",formOauthTitle:"form-oauth-title-Mvl0DPCXTi","form-oauth-success":"form-oauth-success-2Jg_gWn8VZ",formOauthSuccess:"form-oauth-success-2Jg_gWn8VZ","form-oauth-refresh":"form-oauth-refresh-w6kKz_clMr",formOauthRefresh:"form-oauth-refresh-w6kKz_clMr","form-oauth-qrcode":"form-oauth-qrcode-TzOZF-f4KR",formOauthQrcode:"form-oauth-qrcode-TzOZF-f4KR","form-desc-warning":"form-desc-warning-bKx-UVyrA7",formDescWarning:"form-desc-warning-bKx-UVyrA7"}}}]);